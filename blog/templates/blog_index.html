{% extends 'main.html' %}

{% block title %}{% if search %}{{ search }} :: {% elif tag %}{{ tag }}:: {% endif %}Блог{% endblock %}

{% block main %}

{# Подключение шаблона сообщений #}
{% include 'generic/messages.html' %}
{# Форма поиска #}
<div class="search-form">
    <form action="" method="get">
        <input type="text" name="search" value="{{ search }}">
        <input type="submit" value="Найти">
    </form>
</div>

<h2>Блог</h2>

{# Если у пользователя есть права на добавление поста - выводится ссылка на страницу добавления #}
{% if perms.blog.add_blog %}
<p><a href="{% url 'blog_create' %}">Добавить статью</a></p>
{% endif %}

{# Список постов #}
{% for object in latest %}

<div class="blog-article">

    {# Заголовок, с ссылкой на страницу подробностей #}
    <h3><a href="{% url 'blog_detail' pk=object.pk %}?page={{ page_obj.number}}
                    {% if search %}&search={{ search }}{% endif %}
                    {% if tag %}&tag={{ tag }}{% endif %}">
        {{ object.title }}
    </a></h3>

        {# Краткое содержание #}
    <p>{{ object.description }}</p>

    {# Имя автора #}
    <p>
    {% if object.user.get_full_name %}
        {{ object.user.get_full_name }}
    {% else %}
        {{ object.user.get_username }}
    {% endif %}
      :  <small>{{ object.posted|date:'Y.j.m.H:i' }}</small>
    </p>

    {# Список тегов поста #}
    {% with names=object.tags.names %}
        {% if names.count > 0 %}
            <p>{% for name in names %}
                {% if not forloop.first %},{% endif %}
              Теги:  <a href="{% url 'blog_index' %}?tag={{ name|urlencode }}">{{ name }}</a>
                {% endfor %}
            </p>
        {% endif %}
    {% endwith %}


    {# Если у пользователя есть соответствующие права #}
    {# Вывод ссылок на страницу правки поста #}
    {% if user == object.user or user.is_superuser %}
    <p class="buttons">
        {% if perms.blog.change_blog %}
        <a href="{% url 'blog_edit' pk=object.pk %}?page={{ page_obj.number}}
                    {% if search %}&search={{ search }}{% endif %}
                    {% if tag %}&tag={{ tag }}{% endif %}">Изменить</a>
        {% endif %}

    {# Если у пользователя есть соответствующие права #}
    {# Вывод ссылок на страницу удаления поста #}
        {% if perms.blog.delete_blog %}
        <a href="{% url 'blog_delete' pk=object.pk %}?page={{ page_obj.number}}
                    {% if search %}&search={{ search }}{% endif %}
                    {% if tag %}&tag={{ tag }}{% endif %}">Удалить</a>
        {% endif %}
     {% endif %}
    </p>

</div>
{% endfor %}

{# Подключение шаблона пагинации #}
{% include 'generic/pagination.html' %}

{% endblock %}